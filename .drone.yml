build:
  image: clojure
  commands:
    # install node
    - apt-get install curl
    - curl --silent --location https://deb.nodesource.com/setup_7.x | bash -
    - apt-get install -y nodejs
    - npm i
    # install phantom js
    - export PHANTOM_JS="phantomjs-2.1.1-linux-x86_64"
    - wget https://bitbucket.org/ariya/phantomjs/downloads/$PHANTOM_JS.tar.bz2
    - tar xvjf $PHANTOM_JS.tar.bz2
    - mv $PHANTOM_JS /usr/local/share
    - ln -sf /usr/local/share/$PHANTOM_JS/bin/phantomjs /usr/local/bin
    # run tests
    - lein doo phantom test once
deploy:
  rsync:
    user: $$PROD_USER
    host: $$PROD_HOST
    port: 22
    source: ./docker-compose.yml
    target: /tmp/$$COMMIT/
    delete: false
    commands:
      - docker-compose -f /tmp/$$COMMIT/docker-compose.yml pull
      - docker-compose -f /tmp/$$COMMIT/docker-compose.yml -p russyll up -d
    when:
      branch: master

publish:
  docker:
    username: $$DOCKER_USERNAME
    password: $$DOCKER_PASSWORD
    email: $$DOCKER_EMAIL
    storage_driver: vfs
    repo: omelhoro1/russyll
    when:
      branch: master
