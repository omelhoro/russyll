pipeline:

  build:
    image: theasp/clojurescript-nodejs
    commands:
      # install node
      # - apt-get install curl
      # - curl --silent --location https://deb.nodesource.com/setup_9.x | bash -
      # - apt-get install -y nodejs
      - npm i
      # install phantom js
      - ln -sf $PWD/node_modules/phantomjs-prebuilt/lib/phantom/bin/phantomjs /usr/local/bin
      - phantomjs -v
      # run tests
      - lein doo phantom test once

  docker:
    image: plugins/docker
    storage_driver: vfs
    repo: omelhoro1/russyll
    secrets: [ docker_username, docker_password ]
    when:
      branch: master

  deploy:
    image: drillster/drone-rsync
    user: captain
    hosts: [ "software-unchained.com" ]
    port: 22
    target: /tmp/russyll-${DRONE_COMMIT}/
    include:
      - "docker-compose.yml"
    exclude:
      - "**.*"
    delete: false
    secrets: [ rsync_key ]
    script:
      - docker-compose -f /tmp/russyll-${DRONE_COMMIT}/docker-compose.yml pull
      - docker-compose -f /tmp/russyll-${DRONE_COMMIT}/docker-compose.yml -p russyll up -d
    when:
      branch: master
